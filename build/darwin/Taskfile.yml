version: '3'

includes:
  common: ../Taskfile.yml

vars:
  # Signing configuration - edit these values for your project
  # SIGN_IDENTITY: "Developer ID Application: Your Name (TEAM_ID)"
  # NOTARIZATION_PROFILE: "notarization-profile-name"
  #
  # Password/API Key is stored securely in system keychain. Run: wails3 setup signing

tasks:
  build:
    summary: Builds the application for macOS
    deps:
      - task: common:go:mod:tidy
      - task: common:build:frontend
        vars:
          BUILD_FLAGS:
            ref: .BUILD_FLAGS
          DEV:
            ref: .DEV
      - task: common:generate:icons
    cmds:
      # Check if building universal binary
      - |
        if [ "{{.ARCH}}" = "universal" ]; then
          echo "Building universal binary..."
          # Build for amd64
          GOOS=darwin GOARCH=amd64 CGO_ENABLED=1 go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}-amd64
          # Build for arm64
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=1 go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}-arm64
          # Merge with lipo
          lipo -create -output {{.BIN_DIR}}/{{.APP_NAME}} {{.BIN_DIR}}/{{.APP_NAME}}-amd64 {{.BIN_DIR}}/{{.APP_NAME}}-arm64
          # Clean up intermediate files
          rm -f {{.BIN_DIR}}/{{.APP_NAME}}-amd64 {{.BIN_DIR}}/{{.APP_NAME}}-arm64
        else
          # Build for specific architecture
          go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}
        fi
      - task: create:app:bundle
    vars:
      BUILD_FLAGS: '{{if eq .DEV "true"}}-buildvcs=false -gcflags=all="-l"{{else}}-tags production -trimpath -buildvcs=false -ldflags="-w -s"{{end}}'
    env:
      GOOS: darwin
      CGO_ENABLED: 1
      GOARCH: '{{if ne .ARCH "universal"}}{{.ARCH | default ARCH}}{{else}}{{end}}'

  create:app:bundle:
    summary: Creates a macOS .app bundle
    internal: true
    cmds:
      - mkdir -p {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS
      - mkdir -p {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources
      - cp {{.BIN_DIR}}/{{.APP_NAME}} {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS/
      - cp build/darwin/icons.icns {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources/
      - |
        cat > {{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CFBundleExecutable</key>
          <string>{{.APP_NAME}}</string>
          <key>CFBundleIconFile</key>
          <string>icons.icns</string>
          <key>CFBundleIdentifier</key>
          <string>com.mrrss.app</string>
          <key>CFBundleName</key>
          <string>{{.APP_NAME}}</string>
          <key>CFBundlePackageType</key>
          <string>APPL</string>
          <key>CFBundleShortVersionString</key>
          <string>1.3.7</string>
          <key>CFBundleVersion</key>
          <string>1.3.7</string>
          <key>LSMinimumSystemVersion</key>
          <string>10.13</string>
          <key>NSHighResolutionCapable</key>
          <true/>
          <key>NSSupportsAutomaticGraphicsSwitching</key>
          <true/>
        </dict>
        </plist>
        EOF

  package:
    summary: Packages the application into a DMG
    deps:
      - task: build
    cmds:
      - task: create:dmg

  create:dmg:
    summary: Creates a DMG installer
    cmds:
      - |
        if [ -f "build/darwin/create-dmg.sh" ]; then
          chmod +x build/darwin/create-dmg.sh
          ./build/darwin/create-dmg.sh
        else
          echo "Warning: create-dmg.sh not found, skipping DMG creation"
        fi

  run:
    cmds:
      - '{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS/{{.APP_NAME}}'

  sign:
    summary: Signs the macOS application
    desc: |
      Signs the .app bundle with an Apple Developer certificate.
      Configure SIGN_IDENTITY in the vars section at the top of this file.
    deps:
      - task: build
    cmds:
      - codesign --deep --force --verify --verbose --sign "{{.SIGN_IDENTITY}}" --options runtime {{.BIN_DIR}}/{{.APP_NAME}}.app
    preconditions:
      - sh: '[ -n "{{.SIGN_IDENTITY}}" ]'
        msg: "SIGN_IDENTITY is required. Set it in the vars section at the top of build/darwin/Taskfile.yml"

  notarize:
    summary: Notarizes the macOS application
    desc: |
      Notarizes the .app bundle or DMG with Apple's notarization service.
      Configure NOTARIZATION_PROFILE in the vars section at the top of this file.
    deps:
      - task: sign
    cmds:
      - xcrun notarytool submit {{.BIN_DIR}}/{{.APP_NAME}}.app --keychain-profile "{{.NOTARIZATION_PROFILE}}" --wait
      - xcrun stapler staple {{.BIN_DIR}}/{{.APP_NAME}}.app
    preconditions:
      - sh: '[ -n "{{.NOTARIZATION_PROFILE}}" ]'
        msg: "NOTARIZATION_PROFILE is required. Set it in the vars section at the top of build/darwin/Taskfile.yml"
  build:server:
    summary: Builds the server version using Docker
    deps:
      - task: common:build:frontend
    cmds:
      - docker build -f Dockerfile.server -t mrrss-server:latest .
      - docker create --name mrrss-server-temp mrrss-server:latest
      - docker cp mrrss-server-temp:/app/mrrss-server {{.BIN_DIR}}/{{.APP_NAME}}-server
      - docker rm mrrss-server-temp
    preconditions:
      - sh: docker info > /dev/null 2>&1
        msg: "Docker is required for building the server version"

  run:server:
    summary: Runs the server version
    deps:
      - task: build:server
    cmds:
      - '{{.BIN_DIR}}/{{.APP_NAME}}-server'
